name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: '8.0.x'
  MYSQL_SERVICE_VERSION: '8.0'
  DB_NAME: JaemyWeb

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:${{ env.MYSQL_SERVICE_VERSION }}
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: ${{ env.DB_NAME }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -u${{ secrets.MYSQL_USER }} -p${{ secrets.MYSQL_PASSWORD }}"
          --health-interval=10s --health-timeout=5s --health-retries=5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: nuget-${{ runner.os }}-

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Install EF Core Tools
        run: dotnet tool install --global dotnet-ef

      - name: Wait for MySQL (extra safety)
        run: |
          for i in {1..30}; do
            mysqladmin ping -h 127.0.0.1 -u"${{ secrets.MYSQL_USER }}" -p"${{ secrets.MYSQL_PASSWORD }}" && break
            sleep 2
          done

      - name: Apply migrations
        # add --project / --startup-project if needed for your solution structure
        run: dotnet ef database update
        env:
          ConnectionStrings__DefaultConnection: "Server=localhost;Port=3306;Database=${{ env.DB_NAME }};User=${{ secrets.MYSQL_USER }};Password=${{ secrets.MYSQL_PASSWORD }};"

      - name: Test
        run: dotnet test --no-build --configuration Release --verbosity normal
        env:
          ConnectionStrings__DefaultConnection: "Server=localhost;Port=3306;Database=${{ env.DB_NAME }};User=${{ secrets.MYSQL_USER }};Password=${{ secrets.MYSQL_PASSWORD }};"

      - name: Publish
        if: ${{ github.event_name != 'pull_request' }} # skip publish on PRs
        run: dotnet publish --no-build --configuration Release --output ./publish
        env:
          ConnectionStrings__DefaultConnection: "Server=localhost;Port=3306;Database=${{ env.DB_NAME }};User=${{ secrets.MYSQL_USER }};Password=${{ secrets.MYSQL_PASSWORD }};"

      - name: Upload artifact
        if: ${{ github.event_name != 'pull_request' }} # optional
        uses: actions/upload-artifact@v4
        with:
          name: published-app
          path: ./publish

  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: always()   # run even if build failed
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: .NET Vulnerability Scan
        run: |
          dotnet list package --vulnerable --include-transitive 2>&1 | tee security-scan.log
          # Fail the job if vulnerabilities are found (optional gate)
          if grep -q "has the following vulnerable packages" security-scan.log; then
            echo "Vulnerabilities found"; exit 1; fi

  notify:
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    if: always()
    steps:
      - name: Notify build status
        run: |
          if [ "${{ needs.build-and-test.result }}" = "success" ] && [ "${{ needs.security-scan.result }}" = "success" ]; then
            echo "✅ Build, tests, and scan successful!"
          else
            echo "❌ Something failed. build-and-test=${{ needs.build-and-test.result }}, security-scan=${{ needs.security-scan.result }}"
          fi
